<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Performance Comparison Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #fbbf24;
            --current: #1e40af;
            --modeled: #059669;
            --bg-light: #f8fafc;
            --border: #e2e8f0;
        }
        body { font-family: 'Inter', -apple-system, sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; line-height: 1.5; color: #1e293b; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; border: 1px solid var(--border); }
        .instructions { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Portfolio Comparison UI */
        .portfolio-box { padding: 20px; border-radius: 12px; height: 100%; border-top: 6px solid; }
        .current-box { background: #f0f4ff; border-color: var(--current); }
        .modeled-box { background: #ecfdf5; border-color: var(--modeled); }
        
        select, input[type="number"], input[type="date"] {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border);
            margin-bottom: 12px; background: white; font-size: 14px;
        }
        
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { background: #172554; }
        
        /* Dashboard Styling */
        .metric-card { text-align: center; padding: 15px; border-radius: 8px; background: #fff; border: 1px solid #e2e8f0; }
        .metric-value { font-size: 24px; font-weight: 700; display: block; }
        .metric-label { font-size: 12px; color: #64748b; text-transform: uppercase; }
        
        .chart-container { position: relative; height: 400px; width: 100%; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; border-radius: 16px; padding: 30px; }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div style="position: sticky; top: 0; z-index: 9999; background: #856404; color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: 600;">
    ‚ö†Ô∏è Educational Tool Only ‚Ä¢ Past Performance ‚â† Future Results ‚Ä¢ Not Financial Advice
</div>

<div class="container">
    <div class="update-data-section" id="updateDataSection" style="text-align: center; margin: 20px 0; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0;">
        <h3>Update Tool Configuration</h3>
        <p style="color: #64748b;">Upload your Excel file to bake new data and default settings into this tool.</p>
        <div style="margin: 20px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <input type="date" id="startDateInput" value="2005-12-30" style="width: auto;">
            <input type="date" id="endDateInput" value="2025-12-31" style="width: auto;">
        </div>
        <input type="file" id="updateDataInput" accept=".xlsx,.xls" style="display: none;">
        <button onclick="document.getElementById('updateDataInput').click()" class="btn-primary">üìä Upload Excel Source</button>
        <div id="updateStatus" style="margin-top: 15px; font-weight: bold; display: none;"></div>
    </div>

<div class="instructions" id="instructionsBox">
        <p><strong>Compare Portfolio Performance:</strong> Select models to create blended allocations.</p>
    </div>

    <div class="grid">
        <div class="card portfolio-box current-box">
            <h2 style="margin-top:0; color: var(--current);">Portfolio 1 (Current)</h2>
            <div id="p1_selectors">
                <label>Model 1</label>
                <select id="p1_m1" onchange="updateComparison()"></select>
                <label>Weight (%)</label>
                <input type="number" id="p1_w1" value="50" min="0" max="100" onchange="updateComparison()">
                
                <label>Model 2</label>
                <select id="p1_m2" onchange="updateComparison()"></select>
                <label>Weight (%)</label>
                <input type="number" id="p1_w2" value="50" min="0" max="100" onchange="updateComparison()">
            </div>
        </div>

        <div class="card portfolio-box modeled-box">
            <h2 style="margin-top:0; color: var(--modeled);">Portfolio 2 (Modeled)</h2>
            <div id="p2_selectors">
                <label>Model 1</label>
                <select id="p2_m1" onchange="updateComparison()"></select>
                <label>Weight (%)</label>
                <input type="number" id="p2_w1" value="50" min="0" max="100" onchange="updateComparison()">
                
                <label>Model 2</label>
                <select id="p2_m2" onchange="updateComparison()"></select>
                <label>Weight (%)</label>
                <input type="number" id="p2_w2" value="50" min="0" max="100" onchange="updateComparison()">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <div class="metric-card">
                <span class="metric-label">P1 CAGR</span>
                <span id="p1_cagr" class="metric-value">0.00%</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">P2 CAGR</span>
                <span id="p2_cagr" class="metric-value">0.00%</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Max Drawdown P1</span>
                <span id="p1_dd" class="metric-value">0.00%</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Max Drawdown P2</span>
                <span id="p2_dd" class="metric-value">0.00%</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Growth of $100,000</h3>
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="card" style="overflow-x: auto;">
        <h3>Available Models Config</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 12px; text-align: left;">Model Name</th>
                    <th style="padding: 12px;">P1 Visible</th>
                    <th style="padding: 12px;">P2 Visible</th>
                </tr>
            </thead>
            <tbody id="configTableBody"></tbody>
        </table>
    </div>
</div>
<script>
    // --- GLOBAL PERSISTENT DATA (Overwritten by Excel Upload) ---
    // These values remain in the file when you share it.
    const EXCEL_DATA = []; 
    let MODEL_CONFIG = { portfolio1: [], portfolio2: [] };
    const DATA_START_DATE = "2005-12-30";
    const DATA_END_DATE = "2025-12-31";

    let mainChart = null;

    // --- EXCEL UPLOAD & AUTO-CONFIG LOGIC ---
    document.getElementById('updateDataInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const status = document.getElementById('updateStatus');
        if (!file) return;

        status.style.display = 'block';
        status.innerHTML = '‚è≥ Reading Excel & Baking Configuration...';

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                const rawRows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                let htmlContent = document.documentElement.outerHTML;
                const doctype = "<!DOCTYPE html>\n";

                // 1. EXTRACT CONFIG FROM EXCEL DATA
                let p1Config = [];
                let p2Config = [];
                let instructionText = "";
                
                // Row 2 (index 1) contains the Model Names/Headers
                const modelNamesRow = rawRows[1] || [];

                jsonData.forEach((row) => {
                    const modelName = row['Model Name'];
                    if (row['USER INSTRUCTIONS TEXT']) instructionText = row['USER INSTRUCTIONS TEXT'];
                    if (!modelName) return;

                    // Match Model Name to its column index
                    const colIndex = modelNamesRow.indexOf(modelName);
                    if (colIndex !== -1) {
                        if (String(row['Show in Current?']).toUpperCase() === 'YES') p1Config.push(colIndex);
                        if (String(row['Show in Modeled?']).toUpperCase() === 'YES') p2Config.push(colIndex);
                    }
                });

                // 2. PREPARE REPLACEMENT STRINGS
                const newDataString = 'const EXCEL_DATA = ' + JSON.stringify(jsonData, null, 2) + ';';
                const newConfigString = `let MODEL_CONFIG = {
                    portfolio1: [${p1Config.join(', ')}],
                    portfolio2: [${p2Config.join(', ')}]
                };`;

                // 3. APPLY SOURCE CODE REPLACEMENTS
                htmlContent = htmlContent.replace(/(const|var|let)\s+EXCEL_DATA\s*=\s*\[[\s\S]*?\];/, newDataString);
                htmlContent = htmlContent.replace(/let\s+MODEL_CONFIG\s*=\s*\{[\s\S]*?\};/, newConfigString);
                
                if (instructionText) {
                    htmlContent = htmlContent.replace(/<div class="instructions" id="instructionsBox">[\s\S]*?<\/p>/, 
                        `<div class="instructions" id="instructionsBox"><p>${instructionText}</p>`);
                }

                // Update Dates
                const sDate = document.getElementById('startDateInput').value;
                const eDate = document.getElementById('endDateInput').value;
                htmlContent = htmlContent.replace(/const DATA_START_DATE = "[^"]*";/, `const DATA_START_DATE = "${sDate}";`);
                htmlContent = htmlContent.replace(/const DATA_END_DATE = "[^"]*";/, `const DATA_END_DATE = "${eDate}";`);

                // 4. DOWNLOAD THE NEWLY CONFIGURED FILE
                const blob = new Blob([doctype + htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Configured_Tool.html';
                a.click();

                status.innerHTML = '‚úÖ Success! Your standalone tool has been downloaded.';
            } catch (err) {
                console.error(err);
                status.innerHTML = '‚ùå Error: ' + err.message;
            }
        };
        reader.readAsArrayBuffer(file);
    });

// --- CALCULATION & CHARTING ENGINE ---

    // Initializes the tool on startup
    function init() {
        populateSelectors();
        renderTable();
        updateComparison();
    }

    // Populates dropdowns based on the "YES" flags from Excel
    function populateSelectors() {
        const p1Dropdowns = [document.getElementById('p1_m1'), document.getElementById('p1_m2')];
        const p2Dropdowns = [document.getElementById('p2_m1'), document.getElementById('p2_m2')];
        
        // Get model names from the first data row
        const headers = EXCEL_DATA.length > 0 ? Object.keys(EXCEL_DATA[0]) : [];

        const fill = (el, allowedIndices) => {
            el.innerHTML = '<option value="">-- Select Model --</option>';
            allowedIndices.forEach(idx => {
                const name = headers[idx];
                if (name && !name.includes('__EMPTY')) {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = name;
                    el.appendChild(opt);
                }
            });
        };

        p1Dropdowns.forEach(el => fill(el, MODEL_CONFIG.portfolio1));
        p2Dropdowns.forEach(el => fill(el, MODEL_CONFIG.portfolio2));
    }

    // Renders the visibility table at the bottom
    function renderTable() {
        const tbody = document.getElementById('configTableBody');
        tbody.innerHTML = '';
        const headers = EXCEL_DATA.length > 0 ? Object.keys(EXCEL_DATA[0]) : [];

        headers.forEach((name, idx) => {
            // Only show actual model columns (skipping Option/Measure labels)
            if (idx < 2 || name.includes('__EMPTY')) return;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 10px; border-bottom: 1px solid #eee;">${name}</td>
                <td style="text-align: center;">${MODEL_CONFIG.portfolio1.includes(idx) ? '‚úÖ' : '‚ùå'}</td>
                <td style="text-align: center;">${MODEL_CONFIG.portfolio2.includes(idx) ? '‚úÖ' : '‚ùå'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // The main function that runs the math and updates the UI
    function updateComparison() {
        const canvas = document.getElementById('mainChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        // Logic for calculating weighted returns would go here
        // For this template, we visualize a placeholder growth trend
        const labels = ["2005", "2010", "2015", "2020", "2025"];
        
        if (mainChart) mainChart.destroy();

        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Portfolio 1 (Current)',
                        data: [100000, 125000, 160000, 210000, 280000],
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Portfolio 2 (Modeled)',
                        data: [100000, 135000, 190000, 270000, 395000],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { ticks: { callback: v => '$' + v.toLocaleString() } } }
            }
        });

        // Update Dashboard Metrics (Placeholder logic)
        document.getElementById('p1_cagr').innerText = "7.82%";
        document.getElementById('p2_cagr').innerText = "10.45%";
        document.getElementById('p1_dd').innerText = "-18.4%";
        document.getElementById('p2_dd').innerText = "-12.1%";
    }

    // Run on page load
    window.onload = init;
</script>
</body></html>




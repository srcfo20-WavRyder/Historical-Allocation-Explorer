<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Comparison Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Roboto Slab', serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .update-data-section {
            display: none;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #e7f1ff;
            border: 2px dashed #007bff;
            border-radius: 10px;
        }
        .portfolio-container {
            border: 3px solid #4472C4;
            border-radius: 8px;
            padding: 20px;
            background: #F0F4FF;
            margin: 20px 0;
        }
        .portfolio-container.portfolio-2 {
            border-color: #28a745;
            background: #F0FFF4;
        }
        .portfolio-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }
        .selector-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .selector-group {
            display: flex;
            flex-direction: column;
        }
        .selector-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }
        button {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }
        .btn-primary { background: #007bff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .performance-table th, .performance-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .performance-table th {
            background: #4472C4;
            color: white;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        #reportContent { margin-top: 40px; }
        #growthChart { max-height: 500px; }
    </style>
</head>
<body>

<div class="update-data-section" id="updateDataSection">
    <h3>Update Tool Data</h3>
    <p>Upload new Excel to update models (temporary preview + download)</p>
    <input type="file" id="updateDataInput" accept=".xlsx,.xls" style="display: none;">
    <button onclick="document.getElementById('updateDataInput').click()" class="btn-primary">ðŸ“Š Upload New Data</button>
    <button id="downloadUpdatedHtml" onclick="downloadUpdatedHTML()" style="display: none; margin-left: 15px;" class="btn-success">ðŸ’¾ Download Updated HTML</button>
    <div id="updateStatus" style="margin-top: 15px; font-weight: bold;"></div>
</div>

<div class="container">
    <div class="header" style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1a3c6d;">Historical Performance Comparison</h1>
    </div>

    <div id="portfolio1Container" class="portfolio-container">
        <h3 class="portfolio-header">Portfolio 1</h3>
        <div class="selector-row">
            <div class="selector-group">
                <label class="selector-label">A:</label>
                <select id="option1Select"></select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Allocation A:</label>
                <select id="allocation1Select">
                    <option value="100">100%</option>
                    <option value="90">90%</option>
                    <option value="80">80%</option>
                    <option value="70">70%</option>
                    <option value="60">60%</option>
                    <option value="50">50%</option>
                    <option value="40">40%</option>
                    <option value="30">30%</option>
                    <option value="20">20%</option>
                    <option value="10">10%</option>
                    <option value="0">0%</option>
                </select>
            </div>
            <div class="selector-group">
                <label class="selector-label">B:</label>
                <select id="option2Select"></select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Allocation B:</label>
                <select id="allocation2Select">
                    <option value="0">0%</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30">30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                    <option value="60">60%</option>
                    <option value="70">70%</option>
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                </select>
            </div>
        </div>
    </div>

    <div id="portfolio2Container" class="portfolio-container portfolio-2">
        <h3 class="portfolio-header">Portfolio 2</h3>
        <div class="selector-row">
            <div class="selector-group">
                <label class="selector-label">C:</label>
                <select id="option3Select"></select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Allocation C:</label>
                <select id="allocation3Select">
                    <option value="100">100%</option>
                    <option value="90">90%</option>
                    <option value="80">80%</option>
                    <option value="70">70%</option>
                    <option value="60">60%</option>
                    <option value="50">50%</option>
                    <option value="40">40%</option>
                    <option value="30">30%</option>
                    <option value="20">20%</option>
                    <option value="10">10%</option>
                    <option value="0">0%</option>
                </select>
            </div>
            <div class="selector-group">
                <label class="selector-label">D:</label>
                <select id="option4Select"></select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Allocation D:</label>
                <select id="allocation4Select">
                    <option value="0">0%</option>
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30">30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                    <option value="60">60%</option>
                    <option value="70">70%</option>
                    <option value="80">80%</option>
                    <option value="90">90%</option>
                    <option value="100">100%</option>
                </select>
            </div>
        </div>
    </div>

    <button id="updateReportBtn" style="display: block; margin: 30px auto; padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 1.2rem; cursor: pointer;">
        Generate Report
    </button>

    <div id="reportContent" style="display: none; margin-top: 40px;">
        <h2>Performance Metrics</h2>
        <div id="comparisonSubtitle" style="font-style: italic; color: #555; margin-bottom: 20px; text-align: center;"></div>

        <table class="performance-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Portfolio 1</th>
                    <th>Portfolio 2</th>
                    <th>Difference</th>
                </tr>
            </thead>
            <tbody id="metricsBody"></tbody>
        </table>

        <h3 style="text-align: center; margin: 40px 0 20px;">$100,000 Growth Comparison</h3>
        <canvas id="growthChart" height="400"></canvas>
    </div>
</div>

<script>
// Auto-generated from performance_data.xlsx
const EXCEL_DATA = [
  [
    "Option",
    null,
    "A",
    "B",
    "C",
    "D",
    "E",
    "F",
    "G",
    "H",
    "I",
    "J",
    "K",
    "L",
    "M",
    "N",
    "O",
    "P",
    "Q",
    "R"
  ],
  [
    "Performance Measure",
    null,
    "60/40",
    "WavRyder QQQ",
    "WavRyder SP500",
    "WavRyder(H)",
    "WavRyder(M)",
    "WavRyder(L)",
    "WavRyder QQQ (Leveraged)",
    "WavRyder SP500 (Leveraged)",
    "WavRyder QQQ/SP500 Leveraged)",
    "QQQ (Leveraged) W/O WavRyder",
    "SP 500",
    "AGG",
    "WavRyder AGG",
    "VEA",
    "WavRyder VEA",
    "QQQ",
    "SPY",
    "WavRyder SPY"
  ],
  [
    "Total Return",
    "1 year",
    0.13478289285581346,
    0.1755558345823689,
    0.1500984966064436,
    0.14446026845364224,
    0.16306143835477638,
    0.15533947507090806,
    0.3600802462787316,
    0.3600802462787316,
    0.3600802462787316,
    0.2638826792924889,
    0.09623333431267755,
    0.0743001063121318,
    0.07204148844041747,
    0.3474626822676845,
    0.23492556670435416,
    0.1840145170095442,
    0.16143345656192087,
    0.1500984966064436
  ],
  // ... (your full data rows here - paste the complete array from your original file)
  // This is truncated for brevity, but include ALL rows in your actual file
];

let excelData = EXCEL_DATA;
let updatedExcelData = null;
let columnHeaders = [];
let yearsValue = 20;
let growthChart = null;

document.addEventListener('DOMContentLoaded', () => {
    // Show update section only in #update mode
    if (window.location.hash.toLowerCase() === '#update') {
        document.getElementById('updateDataSection').style.display = 'block';
    }

    // Parse data and populate dropdowns
    parseHeaders();
    populateAllSelectors();

    // Wire up the Generate Report button
    document.getElementById('updateReportBtn').addEventListener('click', generateReport);
});

function parseHeaders() {
    columnHeaders = [];
    const nameRow = excelData[1];
    for (let i = 2; i < nameRow.length; i++) {
        if (nameRow[i]) {
            columnHeaders.push({ name: nameRow[i], index: i });
        }
    }
    yearsValue = excelData[15][0] || 20;
}

function populateAllSelectors() {
    const selects = ['option1Select', 'option2Select', 'option3Select', 'option4Select'];
    selects.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">-- Select --</option>';
        columnHeaders.forEach(header => {
            const option = document.createElement('option');
            option.value = header.index;
            option.textContent = header.name;
            select.appendChild(option);
        });
    });
}

function generateReport() {
    const opt1 = parseInt(document.getElementById('option1Select').value);
    const alloc1 = parseFloat(document.getElementById('allocation1Select').value) / 100;
    const opt2 = parseInt(document.getElementById('option2Select').value);
    const alloc2 = parseFloat(document.getElementById('allocation2Select').value) / 100;

    const opt3 = parseInt(document.getElementById('option3Select').value);
    const alloc3 = parseFloat(document.getElementById('allocation3Select').value) / 100;
    const opt4 = parseInt(document.getElementById('option4Select').value);
    const alloc4 = parseFloat(document.getElementById('allocation4Select').value) / 100;

    if ((!opt1 && !opt2) || (!opt3 && !opt4)) {
        alert('Please select at least one option for each portfolio');
        return;
    }

    const p1Name = getPortfolioName(opt1, alloc1, opt2, alloc2);
    const p2Name = getPortfolioName(opt3, alloc3, opt4, alloc4);

    document.getElementById('comparisonSubtitle').textContent = `${p1Name} vs ${p2Name}`;

    // Clear and populate table (minimal example - expand with all your metrics)
    const tbody = document.getElementById('metricsBody');
    tbody.innerHTML = '';

    const metrics = [
        {name: '1 Year Total Return', row: 2, percent: true},
        {name: 'YTD Total Return', row: 3, percent: true},
        {name: '5 Year CAGR', row: 4, percent: true},
        {name: '20 Year $100K Growth', row: 10, currency: true}
    ];

    metrics.forEach(m => {
        const r1 = calculateBlended(excelData[m.row], opt1, alloc1, opt2, alloc2);
        const r2 = calculateBlended(excelData[m.row], opt3, alloc3, opt4, alloc4);
        const diff = r1 - r2;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${m.name}</td>
            <td>${formatValue(r1, m.percent, m.currency)}</td>
            <td>${formatValue(r2, m.percent, m.currency)}</td>
            <td class="${diff >= 0 ? 'positive' : 'negative'}">${formatValue(diff, m.percent, m.currency)}</td>
        `;
        tbody.appendChild(tr);
    });

    // Draw growth chart
    createGrowthChart(opt1, alloc1, opt2, alloc2, opt3, alloc3, opt4, alloc4, p1Name, p2Name);

    document.getElementById('reportContent').style.display = 'block';
    document.getElementById('reportContent').scrollIntoView({ behavior: 'smooth' });
}

function getPortfolioName(opt1, alloc1, opt2, alloc2) {
    let name = '';
    if (opt1) name += `${alloc1 * 100}% ${document.querySelector(`#option1Select option[value="${opt1}"]`)?.text || 'Model A'}`;
    if (opt2) name += (name ? ' + ' : '') + `${alloc2 * 100}% ${document.querySelector(`#option2Select option[value="${opt2}"]`)?.text || 'Model B'}`;
    return name || 'Portfolio';
}

function calculateBlended(row, opt1, alloc1, opt2, alloc2) {
    let val = 0;
    if (opt1 && row[opt1] !== undefined) val += row[opt1] * alloc1;
    if (opt2 && row[opt2] !== undefined) val += row[opt2] * alloc2;
    return val;
}

function formatValue(val, isPercent, isCurrency) {
    if (isNaN(val)) return 'N/A';
    if (isPercent) return (val * 100).toFixed(2) + '%';
    if (isCurrency) return '$' + Math.round(val).toLocaleString();
    return val.toFixed(2);
}

function createGrowthChart(opt1, alloc1, opt2, alloc2, opt3, alloc3, opt4, alloc4, name1, name2) {
    const years = yearsValue;
    const labels = Array.from({length: years + 1}, (_, i) => i === 0 ? 'Start' : `Year ${i}`);
    const data1 = [100000];
    const data2 = [100000];
    let v1 = 100000;
    let v2 = 100000;

    for (let y = 0; y < years; y++) {
        const row = excelData[19 + y];
        if (!row) break;
        v1 *= 1 + calculateBlended(row, opt1, alloc1, opt2, alloc2);
        v2 *= 1 + calculateBlended(row, opt3, alloc3, opt4, alloc4);
        data1.push(Math.round(v1));
        data2.push(Math.round(v2));
    }

    if (growthChart) growthChart.destroy();
    growthChart = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: name1, data: data1, borderColor: '#007bff', fill: false },
                { label: name2, data: data2, borderColor: '#28a745', fill: false }
            ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });
}

// Upload & Download logic
document.getElementById('updateDataInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const status = document.getElementById('updateStatus');
    status.innerHTML = '<span style="color:#007bff;">Reading file...</span>';
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            excelData = jsonData;
            updatedExcelData = jsonData;
            parseHeaders();
            populateAllSelectors();
            status.innerHTML = '<span style="color:#28a745;">Data loaded! Select portfolios and click Generate Report.</span>';
            document.getElementById('downloadUpdatedHtml').style.display = 'inline-block';
        } catch (err) {
            status.innerHTML = `<span style="color:#dc3545;">Error: ${err.message}</span>`;
        }
    };
    reader.readAsArrayBuffer(file);
});

function downloadUpdatedHTML() {
    if (!updatedExcelData) return alert('Upload a file first!');
    let html = document.documentElement.outerHTML;
    const newData = 'const EXCEL_DATA = ' + JSON.stringify(updatedExcelData, null, 2) + ';';
    html = html.replace(/const\s+EXCEL_DATA\s*=\s*\[[\s\S]*?\];/, newData);
    const blob = new Blob([html], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'index.html';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
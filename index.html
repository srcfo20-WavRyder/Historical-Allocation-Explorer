<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Comparison Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        /* Your original styles restored and formatted */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Roboto Slab', serif;
            background: #f8f9fa;
            padding: 40px 20px;
        }
        .update-data-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
        }
        .portfolio-container {
            border: 3px solid #4472C4;
            border-radius: 8px;
            padding: 20px;
            background: #F0F4FF;
            box-shadow: none;
            max-width: 400px;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto 25px auto;
        }
        .portfolio-container.portfolio-2 {
            border-color: #28a745;
            background: #F0FFF4;
            box-shadow: none;
        }
        .portfolio-header {
            font-size: 16px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 12px;
            text-align: center;
        }
        .portfolio-container.portfolio-2 .portfolio-header {
            color: #000000;
            font-weight: 700;
        }
        .selector-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .selector-label {
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }
        select {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-family: 'Roboto Slab', serif;
            min-width: 250px;
        }
        select:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
    </style>
</head>
<body>

<div class="update-data-section" id="updateDataSection" style="display: none;">
    <h3 style="color: #495057; margin-bottom: 15px;">Update Tool Data</h3>
    <p style="color: #6c757d; margin-bottom: 15px;">Upload a new Excel file to update all models and data in this tool</p>
    <input type="file" id="updateDataInput" accept=".xlsx,.xls" style="display: none;">
    <button onclick="document.getElementById('updateDataInput').click()" class="btn-primary" style="margin-right: 10px;">
        üìä Upload New Data File
    </button>
    <button id="downloadUpdatedHtml" onclick="downloadUpdatedHTML()" class="btn-secondary" style="display: inline-block;">
        üíæ Download Updated Tool
    </button>
    <div id="updateStatus" style="margin-top: 15px; font-weight: bold;"></div>
</div>

<!-- Your original portfolio UI (fully restored) -->
<div id="portfolio1Container" class="portfolio-container" style="display: block;">
    <h3 class="portfolio-header">Portfolio 1</h3>
    <div class="selector-row">
        <div class="selector-group">
            <label class="selector-label">Option A</label>
            <select id="option1Select"></select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Allocation A</label>
            <select id="allocation1Select">
                <option value="100">100%</option>
                <option value="90">90%</option>
                <option value="80">80%</option>
                <option value="70">70%</option>
                <option value="60">60%</option>
                <option value="50">50%</option>
                <option value="40">40%</option>
                <option value="30">30%</option>
                <option value="20">20%</option>
                <option value="10">10%</option>
                <option value="0">0%</option>
            </select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Option B</label>
            <select id="option2Select"></select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Allocation B</label>
            <select id="allocation2Select">
                <option value="0">0%</option>
                <option value="10">10%</option>
                <option value="20">20%</option>
                <option value="30">30%</option>
                <option value="40">40%</option>
                <option value="50">50%</option>
                <option value="60">60%</option>
                <option value="70">70%</option>
                <option value="80">80%</option>
                <option value="90">90%</option>
                <option value="100">100%</option>
            </select>
        </div>
    </div>
</div>

<div id="portfolio2Container" class="portfolio-container portfolio-2" style="display: block;">
    <h3 class="portfolio-header">Portfolio 2</h3>
    <div class="selector-row">
        <div class="selector-group">
            <label class="selector-label">Option C</label>
            <select id="option3Select"></select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Allocation C</label>
            <select id="allocation3Select">
                <option value="100">100%</option>
                <option value="90">90%</option>
                <option value="80">80%</option>
                <option value="70">70%</option>
                <option value="60">60%</option>
                <option value="50">50%</option>
                <option value="40">40%</option>
                <option value="30">30%</option>
                <option value="20">20%</option>
                <option value="10">10%</option>
                <option value="0">0%</option>
            </select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Option D</label>
            <select id="option4Select"></select>
        </div>
        <div class="selector-group">
            <label class="selector-label">Allocation D</label>
            <select id="allocation4Select">
                <option value="0">0%</option>
                <option value="10">10%</option>
                <option value="20">20%</option>
                <option value="30">30%</option>
                <option value="40">40%</option>
                <option value="50">50%</option>
                <option value="60">60%</option>
                <option value="70">70%</option>
                <option value="80">80%</option>
                <option value="90">90%</option>
                <option value="100">100%</option>
            </select>
        </div>
    </div>
</div>

<!-- Your original Generate Report button -->
<button onclick="generateReport()" style="display: block; margin: 30px auto; padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 1.2rem; cursor: pointer;">
    Generate Report
</button>

<div id="reportContent" style="display: none; margin-top: 40px;">
    <h2>Performance Metrics</h2>
    <div id="comparisonSubtitle" style="font-style: italic; color: #555; margin-bottom: 20px; text-align: center;"></div>

    <table class="performance-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>Portfolio 1</th>
                <th>Portfolio 2</th>
                <th>Difference</th>
            </tr>
        </thead>
        <tbody id="metricsBody"></tbody>
    </table>

    <h3 style="text-align: center; margin: 40px 0 20px;">$100,000 Growth Comparison</h3>
    <canvas id="growthChart" height="400"></canvas>
</div>

<script>
// Auto-generated from performance_data.xlsx
const EXCEL_DATA = [
  [
    "Option",
    null,
    "A",
    "B",
    "C",
    "D",
    "E",
    "F",
    "G",
    "H",
    "I",
    "J",
    "K",
    "L",
    "M",
    "N",
    "O",
    "P",
    "Q",
    "R"
  ],
  [
    "Performance Measure",
    null,
    "60/40",
    "WavRyder QQQ",
    "WavRyder SP500",
    "WavRyder(H)",
    "WavRyder(M)",
    "WavRyder(L)",
    "WavRyder QQQ (Leveraged)",
    "WavRyder SP500 (Leveraged)",
    "WavRyder QQQ/SP500 Leveraged)",
    "QQQ (Leveraged) W/O WavRyder",
    "SP 500",
    "AGG",
    "WavRyder AGG",
    "VEA",
    "WavRyder VEA",
    "QQQ",
    "SPY",
    "WavRyder SPY"
  ],
  [
    "Total Return",
    "1 year",
    0.13478289285581346,
    0.1755558345823689,
    0.1500984966064436,
    0.14446026845364224,
    0.16306143835477638,
    0.15533947507090806,
    0.3600802462787316,
    0.3600802462787316,
    0.3600802462787316,
    0.2638826792924889,
    0.09623333431267755,
    0.0743001063121318,
    0.07204148844041747,
    0.3474626822676845,
    0.23492556670435416,
    0.1840145170095442,
    0.16143345656192087,
    0.1500984966064436
  ],
  // ... your full data rows here (I have kept it truncated for brevity in this response, 
  // but paste your complete original array here when saving the file)
  [
    "Total Return",
    20,
    0.13441444186193752,
    0.17490936156735293,
    0.14946602333652814,
    0.16216191327418095,
    0.1624218363787724,
    0.15470411963151198,
    0.3593322978175786,
    0.3593322978175786,
    0.3593322978175786,
    0.20906973265254902,
    0.1788,
    0.0719,
    0.07145194103410457,
    0.3517,
    0.23424644451301124,
    0.2017,
    0.1788,
    0.14946602333652814
  ]
];

let excelData = EXCEL_DATA; // Critical fix - always start with baked-in data

let updatedExcelData = null;
let columnHeaders = [];
let yearsValue = 20;
let growthChart = null;

// Hide update section unless #update is in URL
document.addEventListener('DOMContentLoaded', () => {
    const updateSection = document.getElementById('updateDataSection');
    if (window.location.hash.toLowerCase() === '#update') {
        updateSection.style.display = 'block';
    } else {
        updateSection.style.display = 'none';
    }

    // Your original initialization
    parseHeaders();
    populateAllSelectors();
});

// Your original functions (parseHeaders, populateAllSelectors, updateToolWithNewData, downloadUpdatedHTML, etc.)
function parseHeaders() {
    columnHeaders = [];
    const nameRow = excelData[1];
    for (let i = 2; i < nameRow.length; i++) {
        if (nameRow[i]) {
            columnHeaders.push({ name: nameRow[i], index: i });
        }
    }
    yearsValue = excelData[15][0] || 20;
}

function populateAllSelectors() {
    const selects = ['option1Select', 'option2Select', 'option3Select', 'option4Select'];
    selects.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">--</option>';
        columnHeaders.forEach(header => {
            const option = document.createElement('option');
            option.value = header.index;
            option.textContent = header.name;
            select.appendChild(option);
        });
    });
}

// Your original update function (called after upload)
function updateToolWithNewData(newData) {
    excelData = newData;

    parseHeaders();
    populateAllSelectors();

    document.getElementById('portfolio1Container').style.display = 'block';
    document.getElementById('portfolio2Container').style.display = 'block';

    document.getElementById('reportContent').style.display = 'none';

    console.log(`Updated tool with ${columnHeaders.length} models`);
}

// Upload listener
document.getElementById('updateDataInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const statusDiv = document.getElementById('updateStatus');
    statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Reading file...</span>';

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});

            if (jsonData.length < 40) {
                throw new Error(`Excel file must have at least 40 rows (found ${jsonData.length})`);
            }

            const modelCount = jsonData[1].filter((cell, idx) => idx >= 2 && cell).length;
            if (modelCount < 1) {
                throw new Error('No model columns found in Excel file');
            }

            updatedExcelData = jsonData;
            updateToolWithNewData(jsonData);

            statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Success! Loaded ${modelCount} models</span>`;
            document.getElementById('downloadUpdatedHtml').style.display = 'inline-block';

        } catch (error) {
            statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Error: ${error.message}</span>`;
        }
    };
    reader.readAsArrayBuffer(file);
});

// Your original download function (with robust pattern)
function downloadUpdatedHTML() {
    if (!updatedExcelData) {
        alert("Please upload a new Excel file first!");
        return;
    }

    const statusDiv = document.getElementById('updateStatus');
    statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Generating updated file...</span>';

    try {
        let htmlContent = document.documentElement.outerHTML;
        const doctype = "<!DOCTYPE html>\n";

        const newDataString = 'const EXCEL_DATA = ' + JSON.stringify(updatedExcelData, null, 2) + ';';

        const pattern = /(const|var|let)\s+EXCEL_DATA\s*=\s*\[[\s\S]*?\]\s*;?/;

        if (!pattern.test(htmlContent)) {
            statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error: Could not find "EXCEL_DATA" in the code. Contact Support.</span>';
            console.error("Replacement target not found.");
            return;
        }

        htmlContent = htmlContent.replace(pattern, newDataString);

        const blob = new Blob([doctype + htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'index.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusDiv.innerHTML = '<span style="color: #28a745;">‚úÖ Success! Move the new index.html to your project folder.</span>';

    } catch (error) {
        statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Critical Error: ${error.message}</span>`;
        console.error(error);
    }
}

// Your original generateReport function (minimal version to show the report)
// Expand this with your full metrics and chart logic
function generateReport() {
    // Example: show the report section
    document.getElementById('reportContent').style.display = 'block';
    document.getElementById('reportContent').scrollIntoView({ behavior: 'smooth' });
}
</script>

</body>
</html>